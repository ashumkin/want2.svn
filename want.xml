<!-- $Id$ -->
<!-- This is the Dante script for building Dante -->
<project name="dante"
         basedir=".."
         default="dist" >

  <property name="version" value="1.0.0" />

  <property name="src"       value="${basedir}/src" />
  <property name="dist"      value="${basedir}/dist" />
  <property name="res"       value="${basedir}/res" />
  <property name="lib"       value="${basedir}/lib" />
  <property name="examples"  value="${basedir}/examples" />

  <property name="bin" value="${basedir}/bin" />
  <property name="dcu" value="${basedir}/dcu" />

  <property name="jcl"     value="${src}/jcl" />
  <property name="paszlib" value="${lib}/paszlib" />


  <target name="prepare" >
    <echo message="basedir=${basedir}" />
    <echo>
    The base directory is ${basedir}
    The source directory is ${src}
    The default command processor is %{comspec}
    </echo>
    <echo message="src=${src}" />
    <echo message="dist=${dist}" />
    <echo message="res=${res}" />
    <echo message="lib=${lib}" />

    <echo message="bin=${bin}" />
    <echo message="dcu=${dcu}" />

    <echo message="jcl=${jcl}" />
    <echo message="paszlib=${paszlib}" />

    <mkdir dir="${dcu}" />
    <mkdir dir="${bin}" />
  </target>

  <target name="clean" >
    <delete dir="${dist}" />
    <delete dir="${dcu}" />
    <delete dir="${bin}" />
  </target>

  <target name="compile" depends="prepare">
    <log file="compile.log" >
      <info code="compile">
        Compile started.
      </info>
    </log>
    <!-- Delete dante.cfg first to get a reproducible build.
         (Should this be automated?)
    -->
    <incverrc rcfilename="${src}/dantever.rc" />

    <!-- should use a brcc task, not written yet -->
    <!-- ToSystemPath in shell task doesn't work on embedded paths,
         so I hardcoded the path for the moment instead of using
         ${src} -->
    <shell executable="brcc32.exe .\src\dantever.rc" />

    <touch  file="${src}/dante.cfg"  />
    <delete file="${src}/dante.cfg" />
    <dcc basedir="${src}"
         source="dante.dpr"
         exes="${basedir}"
         dcus="${dcu}"
         quiet="true"
         build="true"
         optimize="true"
         debug="false"
    >
      <unit path="${jcl}" />
      <unit path="${src}" />
      <unit path="${src}/tasks" />
      <unit path="${src}/xml" />
      <unit path="${src}/paths" />
      <unit path="${src}/zip" />

      <unit path="${paszlib}" />
      <unit path="${paszlib}/minizip" />

      <include path="${jcl}" />

      <resource path="${src}" />
      <resource path="${res}" />
    </dcc>
    <log file="compile.log" >
      <info code="compile">
        Compile suceeded.
      </info>
    </log>
  </target>

  <target name="examples" depends="prepare" >
    <dante dir="${examples}" />
    <dante dir="${examples}/test" />

    <dante buildfile="${examples}/build.xml" />
    <dante buildfile="${examples}/test/build.xml" />
</target>


  <target name="dist" depends="prepare,compile" >
    <mkdir dir="${dist}" />
    <!-- ${build} is supposed to be set internally by incverrc, but it
         ain't workin' at the moment -->
    <property name="zipfile" value="${dist}/dante-${version}.${build}.zip" />
    <delete file="${zipfile}" />
    <zip zipfile="${zipfile}" >
         <exclude name="${dist}/**" />

         <include name="${basedir}/dante.exe" />

         <include name="**/*.pas" />
         <include name="**/*.dpr" />
         <include name="**/*.inc" />
         <include name="**/*.rc" />
         <include name="**/*.res" />
         <include name="**/*.html" />
         <include name="**/*.gif" />
         <include name="**/*.png" />
         <include name="**/*.jpg" />
         <include name="**/*.jpeg" />
         <include name="**/*.txt" />

         <include name="${lib}/paszlib*.zip" />
         <exclude name="${lib}/paszlib/**"   />
         <include name="${lib}/jcl*.zip" />
         <exclude name="${lib}/jcl/**"   />
         <exclude name="${src}/jcl/**"   />
         <exclude name="${basedir}/private/**" />
    </zip>
  </target>

</project>
